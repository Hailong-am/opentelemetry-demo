# Copyright OpenSearch Contributors
# SPDX-License-Identifier: Apache-2.0

otel-logs-pipeline:
  workers: 5
  delay: 10
  source:
    otel_logs_source:
      ssl: false
  processor:
    - add_entries:
        entries:
          - key: "log.attributes.serviceName"
            value_expression: "/serviceName"
            add_when: "/serviceName != null"
          - key: "serviceName"
            value_expression: "/log.attributes.service@name"
            add_when: "/log.attributes.service@name != null"

  buffer:
    bounded_blocking:
  sink:
    - opensearch:
        hosts: OPENSEARCH_HOSTS
        username: OPENSEARCH_USER
        password: OPENSEARCH_PASSWORD
        insecure: true
        index_type: custom
        index: ss4o_logs-%{yyyy.MM.dd}
        bulk_size: 4
        template_type: index-template
        template_content: >
          {
            "index_patterns": [
              "ss4o_logs-*"
            ],
            "template": {
              "mappings": {
                "properties": {
                  "body": {
                    "type": "text"
                  },
                  "droppedAttributesCount": {
                    "type": "long"
                  },
                  "flags": {
                    "type": "long"
                  },
                  "instrumentationScope": {
                    "properties": {
                      "name": {
                        "type": "keyword"
                      },
                      "version": {
                        "type": "text",
                        "fields": {
                          "keyword": {
                            "type": "keyword",
                            "ignore_above": 256
                          }
                        }
                      }
                    }
                  },
                  "log": {
                    "properties": {
                      "attributes": {
                        "properties": {
                          "0": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "@OrderResult": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "ContentRoot": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "EnvName": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "State": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "addr": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "address": {
                            "type": "keyword"
                          },
                          "amount": {
                            "type": "keyword"
                          },
                          "app@product@id": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "app@product@name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "cardType": {
                            "type": "keyword"
                          },
                          "code@file@path": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "code@function@name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "code@line@number": {
                            "type": "long"
                          },
                          "contentRoot": {
                            "type": "keyword"
                          },
                          "context": {
                            "type": "keyword"
                          },
                          "converted_cost": {
                            "type": "float"
                          },
                          "currency": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "destination@address": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "email": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "envName": {
                            "type": "keyword"
                          },
                          "err": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "error": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "event@name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "exception@message": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "exception@stacktrace": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "exception@type": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "failure_probability": {
                            "type": "float"
                          },
                          "failure_type": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "from": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "hostname": {
                            "type": "keyword"
                          },
                          "http": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "https": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "items": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "items_count": {
                            "type": "long"
                          },
                          "lastFourDigits": {
                            "type": "keyword"
                          },
                          "level": {
                            "type": "keyword"
                          },
                          "loyalty_level": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "message": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "order": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "order_id": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "otelServiceName": {
                            "type": "keyword"
                          },
                          "otelSpanID": {
                            "type": "keyword"
                          },
                          "otelTraceID": {
                            "type": "keyword"
                          },
                          "otelTraceSampled": {
                            "type": "boolean"
                          },
                          "paymentInfo": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "pid": {
                            "type": "long"
                          },
                          "productId": {
                            "type": "keyword"
                          },
                          "products": {
                            "type": "long"
                          },
                          "quantity": {
                            "type": "long"
                          },
                          "quote@cents": {
                            "type": "long"
                          },
                          "quote@dollars": {
                            "type": "long"
                          },
                          "quote_service_addr": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "request": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "server@address": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "service@name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "serviceName": {
                            "type": "keyword"
                          },
                          "severity": {
                            "type": "keyword"
                          },
                          "shipping_cost": {
                            "type": "float"
                          },
                          "source@address": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "span_id": {
                            "type": "keyword"
                          },
                          "time": {
                            "type": "date",
                            "format": "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS'Z'||yyyy-MM-dd'T'HH:mm:ss.SSS'Z'||strict_date_optional_time||epoch_millis"
                          },
                          "timestamp": {
                            "type": "date",
                            "format": "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS'Z'||yyyy-MM-dd'T'HH:mm:ss.SSS'Z'||strict_date_optional_time||epoch_millis"
                          },
                          "to": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "total_amount": {
                            "type": "float"
                          },
                          "trace_flags": {
                            "type": "keyword"
                          },
                          "trace_id": {
                            "type": "keyword"
                          },
                          "tracking_id": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "transactionId": {
                            "type": "keyword"
                          },
                          "transaction_id": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "upstream@cluster": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "upstream@host": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "url@full": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "url@path": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "url@query": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "url@template": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "urls": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "userID": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "userId": {
                            "type": "keyword"
                          },
                          "user_agent@original": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "user_currency": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "user_id": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "observedTime": {
                    "type": "date"
                  },
                  "observedTimestamp": {
                    "type": "date"
                  },
                  "resource": {
                    "properties": {
                      "attributes": {
                        "properties": {
                          "cluster_name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "container@id": {
                            "type": "keyword"
                          },
                          "host@arch": {
                            "type": "keyword"
                          },
                          "host@name": {
                            "type": "keyword"
                          },
                          "log_name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "node_name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "os@build_id": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "os@description": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "os@name": {
                            "type": "keyword"
                          },
                          "os@type": {
                            "type": "keyword"
                          },
                          "os@version": {
                            "type": "keyword"
                          },
                          "process@command": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@command_args": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@command_line": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@executable@path": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@owner": {
                            "type": "keyword"
                          },
                          "process@pid": {
                            "type": "long"
                          },
                          "process@runtime@description": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "process@runtime@name": {
                            "type": "keyword"
                          },
                          "process@runtime@version": {
                            "type": "keyword"
                          },
                          "service@instance@id": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "service@name": {
                            "type": "keyword"
                          },
                          "service@namespace": {
                            "type": "keyword"
                          },
                          "service@version": {
                            "type": "keyword"
                          },
                          "telemetry@auto@version": {
                            "type": "keyword"
                          },
                          "telemetry@distro@name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "telemetry@distro@version": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          },
                          "telemetry@sdk@language": {
                            "type": "keyword"
                          },
                          "telemetry@sdk@name": {
                            "type": "keyword"
                          },
                          "telemetry@sdk@version": {
                            "type": "keyword"
                          },
                          "zone_name": {
                            "type": "text",
                            "fields": {
                              "keyword": {
                                "type": "keyword",
                                "ignore_above": 256
                              }
                            }
                          }
                        }
                      }
                    }
                  },
                  "schemaUrl": {
                    "type": "text",
                    "fields": {
                      "keyword": {
                        "type": "keyword",
                        "ignore_above": 256
                      }
                    }
                  },
                  "serviceName": {
                    "type": "keyword"
                  },
                  "severityNumber": {
                    "type": "long"
                  },
                  "severityText": {
                    "type": "keyword"
                  },
                  "spanId": {
                    "type": "keyword"
                  },
                  "time": {
                    "type": "date",
                    "format": "yyyy-MM-dd'T'HH:mm:ss.SSSSSSSSS'Z'||yyyy-MM-dd'T'HH:mm:ss.SSS'Z'||strict_date_optional_time||epoch_millis"
                  },
                  "traceId": {
                    "type": "keyword"
                  }
                }
              },
              "settings": {
                "index": {
                  "mapping": {
                    "total_fields": {
                      "limit": 10000
                    }
                  },
                  "refresh_interval": "5s"
                }
              }
            },
            "composed_of": [],
            "version": 1
          }

entry-pipeline:
  delay: "100"
  source:
    otel_trace_source:
      ssl: false
  sink:
    - pipeline:
        name: "raw-pipeline"
    - pipeline:
        name: "service-map-pipeline"
raw-pipeline:
  source:
    pipeline:
      name: "entry-pipeline"
  processor:
    - otel_trace_raw:
  sink:
    - opensearch:
        hosts: OPENSEARCH_HOSTS
        username: OPENSEARCH_USER
        password: OPENSEARCH_PASSWORD
        insecure: true
        index_type: trace-analytics-raw

service-map-pipeline:
  delay: "100"
  source:
    pipeline:
      name: "entry-pipeline"
  processor:
    - service_map_stateful:
  sink:
    - opensearch:
        hosts: OPENSEARCH_HOSTS
        username: OPENSEARCH_USER
        password: OPENSEARCH_PASSWORD
        insecure: true
        index_type: trace-analytics-service-map
